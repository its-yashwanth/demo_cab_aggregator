name: CI-CD Pipeline (Software Engineering Rubric)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Build Stage
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create required empty __init__.py files for CI
        run: |
          touch backend/__init__.py
          touch backend/app/__init__.py
          touch backend/app/routes/__init__.py
          touch backend/app/utils/__init__.py
          touch backend/tests/__init__.py

  # 2. Test Stage
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create required empty __init__.py files for CI
        run: |
          touch backend/__init__.py
          touch backend/app/__init__.py
          touch backend/app/routes/__init__.py
          touch backend/app/utils/__init__.py
          touch backend/tests/__init__.py
          
      - name: Run tests with pytest
        env:
          PYTHONPATH: .
          SECRET_KEY: "test_secret_key"
          ALGORITHM: "HS256"
          ACCESS_TOKEN_EXPIRE_MINUTES: 30
        run: pytest -q backend/tests/

  # 3. Coverage Stage
  coverage:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create required empty __init__.py files for CI
        run: |
          touch backend/__init__.py
          touch backend/app/__init__.py
          touch backend/app/routes/__init__.py
          touch backend/app/utils/__init__.py
          touch backend/tests/__init__.py
          
      - name: Run Coverage Check
        env:
          PYTHONPATH: .
          SECRET_KEY: "test_secret_key"
          ALGORITHM: "HS256"
          ACCESS_TOKEN_EXPIRE_MINUTES: 30
        run: |
          # Run pytest with coverage, targeting the 'backend' folder
          # Fail if coverage is below the 75% threshold required by the rubric 
          pytest --cov=backend --cov-report=xml --cov-fail-under=75 backend/tests/
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # 4. Lint Stage
  lint:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Lint with flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings.
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  # 5. Security Stage
  security:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Security scan with bandit
        run: |
          bandit -r backend -q

  # 6. Deployment Artifact Stage (NEW)
  # This stage creates the .zip artifact required by the rubric 
  deploy-artifact:
    runs-on: ubuntu-latest
    # This job only runs if ALL previous jobs pass [cite: 786]
    needs: [test, coverage, lint, security]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all CI artifacts (like coverage report)
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create Deployment Package
        run: |
          mkdir -p deployment/
          # Copy source code [cite: 789]
          cp -r backend/ deployment/backend/
          cp -r frontend/ deployment/frontend/
          cp locustfile.py requirements.txt .gitignore .env.example deployment/
          
          # Copy CI/CD reports [cite: 790]
          cp -r artifacts/coverage-report/ deployment/coverage-report/
          
          # Copy documentation [cite: 795]
          cp README.md deployment/README.md
          
          # Create the final zip file 
          zip -r deployment-package.zip deployment/

      - name: Upload Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.zip